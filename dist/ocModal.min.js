/**
 * ocModal - An angularJS modal directive / service
 * @version v0.1.1
 * @link https://github.com/ocombe/ocModal
 * @license MIT
 * @author Olivier Combe <olivier.combe@gmail.com>
 */
!function(){"use strict";var e=angular.module("oc.modal",[]);e.factory("$ocModal",["$rootScope","$controller","$location","$timeout","$compile","$sniffer","$q",function(e,o,n,a,t,l,i){var r,c=angular.element(document.body),s=angular.element('<div role="dialog" tabindex="-1" class="modal"><div class="modal-backdrop"></div></div>'),d=angular.element('<div class="modal-wrapper"></div>'),p={},u=[];d.css("display","none"),d.append(s),c.append(d);var m=s.children()[0];s.on("click.modal",function(o){o.target===m&&e.$apply(function(){g.closeOnEsc()}),o.stopPropagation()});var f=function(e){var o=0,n=angular.isString(e)?e.split(/\s*,\s*/):[];return angular.forEach(n,function(e){o=Math.max(parseFloat(e)||0,o)}),o},v=function(e){var o=0;if(l.transitions||l.animations){var n="animation",a="transition",t=l.vendorPrefix+"Animation",i=l.vendorPrefix+"Transition",r="Duration",c="Delay",s="IterationCount",d=1;angular.forEach(e,function(e){if(e.nodeType==d){var l=window.getComputedStyle(e)||{},p=Math.max(f(l[a+c]),f(l[i+c])),u=Math.max(f(l[n+c]),f(l[t+c])),m=Math.max(f(l[a+r]),f(l[i+r])),v=Math.max(f(l[n+r]),f(l[t+r]));v>0&&(v*=Math.max(parseInt(l[n+s])||0,parseInt(l[t+s])||0,1)),o=Math.max(u+v,p+m,o)}})}return 1e3*o};angular.element(document).on("keyup",function(o){27==o.keyCode&&u.length>0&&(o.stopPropagation(),e.$apply(function(){g.closeOnEsc(u[u.length-1])}))});var g={waitingForOpen:!1,getOpenedModals:function(){return u},register:function(e){p[e.id||"_default"]=e},remove:function(e){delete p[e||"_default"]},open:function(n){"string"==typeof n&&(n=n.match("<")?{template:n}:{url:n});var l=p[n.id||"_default"];if(!l)return s.append(t('<div oc-modal="'+(n.id?n.id:"_default")+'"></div>')(e)),void a(function(){g.open(n)});if(l&&-1!==u.indexOf(n.id||"_default")){if(g.waitingForOpen)return;return g.waitingForOpen=!0,void g.close(n.id).then(function(){g.open(n)})}if(!g.waitingForOpen)if(0===u.length)r=document.body.style.overflow,document.body.style.overflow="hidden",d.css("display","block");else for(var i=0,m=u.length;m>i;i++){var f=p[u[i]].$element;p[u[i]].baseZIndex=f.css("z-index"),f.css("z-index","-1")}g.waitingForOpen=!1,u.push(n.id||"_default"),l.params=n,l.$scope.customClass=l.params.cls,e.$digest(),c[0].offsetWidth,a(function(){l.$scope.modalShow=!0},100),"function"==typeof l.params.onOpen&&l.params.onOpen();var v=l.$scope.$on("$includeContentLoaded",function(e){l.params.init&&!l.params.isolate&&angular.extend(e.targetScope,l.params.init,!0),"string"==typeof l.params.controller&&o(l.params.controller,{$scope:e.targetScope,$init:l.params.init,$ocModalParams:l.params}),v()});if(l.params.template)l.$scope.modalTemplate=l.params.template;else{if(!l.params.url)throw"You need to define a template or an url";l.$scope.modalUrl=l.params.url}"function"==typeof callback&&l.$scope.callbacksList.push(callback)},closeOnEsc:function(e){return p[e||u[u.length-1]].params.closeOnEsc!==!1?g.close(e):void 0},close:function(e){var o,n=i.defer();o="string"==typeof e&&-1!==u.indexOf(e)?Array.prototype.slice.call(arguments,1):arguments,("undefined"==typeof e||-1===u.indexOf(e))&&(e=u[u.length-1]);var t=p[e||u[u.length-1]];if(t&&t.$scope.modalShow===!0){var l=v(angular.element(t.$element[0].querySelector(".modal-content")));a(function(){t.$scope.modalShow=!1,a(function(){if(t.$element.remove(),t.callbacksList=[],u.splice(u.indexOf(e||u[u.length-1]),1),0===u.length)g.waitingForOpen||(document.body.style.overflow=r,d.css("display","none"));else{var a=p[u[u.length-1]];a.$element.css("z-index",a.baseZIndex)}"function"==typeof t.params.onClose&&t.params.onClose.apply(void 0,o),n.resolve()},l)})}else n.resolve();return n.promise}};return g}]),e.directive("ocModal",["$ocModal","$compile","$timeout",function(e,o){return{restrict:"AE",replace:!0,scope:!0,template:'<div class="modal-dialog"><div class="modal-content {{customClass}}" ng-class="{opened: modalShow}" ng-if="modalTemplate"></div><div class="modal-content {{customClass}}" ng-class="{opened: modalShow}" ng-include="modalUrl"></div></div>',link:function(n,a,t){var l,i=t.ocModal;n.closeModal=function(){var o=Array.prototype.slice.call(arguments);o.unshift(i),e.close.apply(void 0,o)},e.register({id:i,$scope:n,$element:a}),a.on("$destroy",function(){e.remove(i)}),n.$watch("modalTemplate",function(e){"undefined"!=typeof e&&(l||(l=angular.element(a.children()[0])),l.append(o(e)(n)),n.$emit("$includeContentLoaded"))})}}}]),e.directive("ocModalOpen",["$ocModal",function(e){return{restrict:"A",require:"?modal",link:function(o,n,a){n.on("click touchstart",function(n){n.preventDefault(),n.stopPropagation();var t=o.$new(),l=t.$eval(a.ocModalOpen);if(l){if("number"==typeof l?l={url:a.ocModalOpen}:"string"==typeof l&&(l={url:l}),!l.url)throw"You need to set the modal url";o.$apply(function(){e.open(l)})}})}}}]),e.directive("ocModalClose",["$ocModal",function(e){return{restrict:"A",require:"?modal",link:function(o,n,a){n.on("click touchstart",function(n){n.preventDefault(),n.stopPropagation(),o.$apply(function(){if(a.ocModalClose)var n=o.$new().$eval(a.ocModalClose);e.close(n)})})}}}])}();